# Manage domains

Using the Myra Security Terraform Provider it is easy to manage (create, read, update and delete) domains.

To have a better structure in your Terraform project, please create a new file `domains.tf`.

## Create a new domain
To create a new domain, you have to add a new `resource` to the `domains.tf` file.

```hcl
resource "myrasec_domain" "example_com" {
  name = "example.com"
}
```

Now, save the file and switch to your command line.
Executing `terraform plan` will show you a preview about what Terraform will change when executing the `terraform apply` command in the next step.

`terraform plan` should output something similar to this
```
Terraform used the selected providers to generate the following execution plan. Resource actions are indicated with the following symbols:
  + create

Terraform will perform the following actions:

  # myrasec_domain.example_com will be created
  + resource "myrasec_domain" "example_com" {
      + auto_update = true
      + created     = (known after apply)
      + domain_id   = (known after apply)
      + id          = (known after apply)
      + modified    = (known after apply)
      + name        = "example.com"
      + paused      = false
    }

Plan: 1 to add, 0 to change, 0 to destroy.

Note: You didn't use the -out option to save this plan, so Terraform can't guarantee to take exactly these actions if you run "terraform
apply" now.
```
Now, you can control the changes and in case everything is correct, apply the changes.  
Running `terraform apply` will create this domain in the Myra application.

Executing `terraform apply --auto-approve` will output something similar to this:

```
Terraform used the selected providers to generate the following execution plan. Resource actions are indicated with the following symbols:
  + create

Terraform will perform the following actions:

  # myrasec_domain.example_com will be created
  + resource "myrasec_domain" "example_com" {
      + auto_update = true
      + created     = (known after apply)
      + domain_id   = (known after apply)
      + id          = (known after apply)
      + modified    = (known after apply)
      + name        = "example.com"
      + paused      = false
    }

Plan: 1 to add, 0 to change, 0 to destroy.
myrasec_domain.example_com: Creating...
myrasec_domain.example_com: Creation complete after 2s [id=0000000]

Apply complete! Resources: 1 added, 0 changed, 0 destroyed.

```

**NOTE** when using the `--auto-approve` option, Terraform won't ask you again for confirmation. Without this option, you have to confirm the changes before Terraform will create the domain.

If you login to the Myra application, you can see the new domain in the domain list.

When you check the files in your terraform project/directory, you will see a file, created by Terraform, called `terraform.tfstate`. This file holds information about the elements/objects maintained by Terraform.  
Using this file, Terraform is able to detect changes on your elements and update those elements in the Myra application.

**Do not edit this file!**  
If you want to change some attribute on a element, you have to do this in your .tf file(s).

Nevertheless, you can open the tfstate file and check the content of this file.

## Update a domain
To update a domain, you have to change the values in the resource definition in your .tf file. First, please add the missing data to your domain resource. The resource should look like this:
```hcl
resource "myrasec_domain" "example_com" {
  name = "example.com"
  auto_update = true
  paused = false
  paused_until = ""
}
```
Running `terraform plan` on the command line should not return any changes:

```
myrasec_domain.example_com: Refreshing state... [id=0000000]

No changes. Your infrastructure matches the configuration.

Terraform has compared your real infrastructure against your configuration and found no differences, so no changes are needed.
```

Now, you can change the `auto_update` value from your domain resource and change the value from `true` to `false`.

**NOTE** changing this value to false will not trigger automatic configuration builds for elements associated with this domain.

Change your domain resource to look like this:

```hcl
resource "myrasec_domain" "example_com" {
  name = "example.com"
  auto_update = false
  paused = false
  paused_until = ""
}
```
Please run `terraform plan` again:
```
Terraform used the selected providers to generate the following execution plan. Resource actions are indicated with the following symbols:
  ~ update in-place

Terraform will perform the following actions:

  # myrasec_domain.example_com will be updated in-place
  ~ resource "myrasec_domain" "example_com" {
      ~ auto_update = true -> false
        id          = "0000000"
        name        = "example.com"
        # (4 unchanged attributes hidden)
    }

Plan: 0 to add, 1 to change, 0 to destroy.

Note: You didn't use the -out option to save this plan, so Terraform can't guarantee to take exactly these actions if you run "terraform
apply" now.
```
After checking the changes that Terraform detected, you can run `terraform apply`.
```
myrasec_domain.example_com: Refreshing state... [id=0000000]

Terraform used the selected providers to generate the following execution plan. Resource actions are indicated with the following symbols:
  ~ update in-place

Terraform will perform the following actions:

  # myrasec_domain.example_com will be updated in-place
  ~ resource "myrasec_domain" "example_com" {
      ~ auto_update = true -> false
        id          = "0000000"
        name        = "example.com"
        # (4 unchanged attributes hidden)
    }

Plan: 0 to add, 1 to change, 0 to destroy.
myrasec_domain.example_com: Modifying... [id=0000000]
myrasec_domain.example_com: Modifications complete after 2s [id=0000000]

Apply complete! Resources: 0 added, 1 changed, 0 destroyed.
```

If you check the `auto_update` value in the `terraform.tfstate` file, you will see the updated value (`false`).

## Delete a domain
To delete an element, you have to delete it's resource in your `.tf` file.
Please remove your domain resource again in the `domains.tf` file (file is empty now) and run `terraform plan`.

```
myrasec_domain.example_com: Refreshing state... [id=0000000]

Terraform used the selected providers to generate the following execution plan. Resource actions are indicated with the following symbols:
  - destroy

Terraform will perform the following actions:

  # myrasec_domain.example_com will be destroyed
  # (because myrasec_domain.example_com is not in configuration)
  - resource "myrasec_domain" "example_com" {
      - auto_update = false -> null
      - created     = "2022-02-16T11:13:23+01:00" -> null
      - domain_id   = 0000000 -> null
      - id          = "0000000" -> null
      - modified    = "2022-02-16T11:28:30+01:00" -> null
      - name        = "example.com" -> null
      - paused      = false -> null
    }

Plan: 0 to add, 0 to change, 1 to destroy.

Note: You didn't use the -out option to save this plan, so Terraform can't guarantee to take exactly these actions if you run "terraform
apply" now.
```
Running `terraform apply` will remove this resource from the `terraform.tfstate` file and remove it from the myra application.

```
myrasec_domain.example_com: Refreshing state... [id=0000000]

Terraform used the selected providers to generate the following execution plan. Resource actions are indicated with the following symbols:
  - destroy

Terraform will perform the following actions:

  # myrasec_domain.example_com will be destroyed
  # (because myrasec_domain.example_com is not in configuration)
  - resource "myrasec_domain" "example_com" {
      - auto_update = false -> null
      - created     = "2022-02-16T11:13:23+01:00" -> null
      - domain_id   = 0000000 -> null
      - id          = "0000000" -> null
      - modified    = "2022-02-16T11:28:30+01:00" -> null
      - name        = "example.com" -> null
      - paused      = false -> null
    }

Plan: 0 to add, 0 to change, 1 to destroy.
myrasec_domain.example_com: Destroying... [id=0000000]
myrasec_domain.example_com: Destruction complete after 1s

Apply complete! Resources: 0 added, 0 changed, 1 destroyed.
```

If you login to the Myra application, you can see that the domain was removed again.

## Importing an existing domain
If you want to manage a domain that is already known by Myra (already created in the app or using the API), please `import` this domain to your Terraform project.    
To import an existing domain, you have to create a resource for this domain in your `domains.tf` file.

```hcl
resource "myrasec_domain" "example_com" {
  name = "example.com"
}
```
Importing an element to your Terraform project requires the ID of the element you want to import. In this case, you need the ID of the existing domain you wish to import.

Running `terraform import myrasec_domain.example_com 0000000` will fetch the domain with ID = `0000000` from the Myra application and import it to your Terraform project (managed by the resource that we defined)
```
myrasec_domain.example_com: Importing from ID "0000000"...
myrasec_domain.example_com: Import prepared!
  Prepared myrasec_domain for import
myrasec_domain.example_com: Refreshing state... [id=0000000]

Import successful!

The resources that were imported are shown above. These resources are now in
your Terraform state and will henceforth be managed by Terraform.
```

## Read a domain
Terraform has resources and data sources. To only fetch information about a domain (but not changing any information about this domain), you can define a data source and load the domain to your `tfstate`.

To read/"import" all your domains as a data source, create a data source definition in your `domains.tf` file like this:
```
data "myrasec_domains" "all" {
    filter {}
}
```

Running `terraform apply` will add the data to your `tfstate`.

Data sources in the `tfstate` have the mode `data` whereas resources have the mode `managed`.

Next step: [Manage DNS records](./dns_records.md)

### Links
[Domain resource documentation](https://registry.terraform.io/providers/Myra-Security-GmbH/myrasec/latest/docs/resources/domain)  
[Domain data source documentation](https://registry.terraform.io/providers/Myra-Security-GmbH/myrasec/latest/docs/data-sources/domains)
